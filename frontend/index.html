<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>De Facto ‚Äì Barom√®tre de Fiabilit√©</title>
  <style>
    :root {
      --bg: #f6f8fb;
      --card: #fff;
      --text: #222;
      --muted: #667;
      --primary: #0a4a9a;
      --ok: #14a44d;
      --warn: #f4a100;
      --bad: #d33c3c;
      --bar: #e9eef6;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
    }

    header {
      background: #0e1117;
      color: #fff;
      text-align: center;
      padding: 1.5rem;
    }

    main {
      max-width: 920px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    textarea {
      width: 100%;
      min-height: 160px;
      border: 1px solid #cdd7e1;
      border-radius: 10px;
      padding: 12px;
      font-size: 15px;
      background: #fff;
    }

    button {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 15px;
      margin-top: 16px;
      display: block;
      margin-left: auto;
      margin-right: auto;
      cursor: pointer;
    }

    button:hover {
      filter: brightness(1.05);
    }

    .result {
      margin-top: 24px;
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.05);
      padding: 24px;
    }

    .score {
      text-align: center;
    }

    .score h2 {
      font-size: 42px;
      margin: 0;
      font-weight: 700;
    }

    .score p {
      margin: 6px 0;
      color: var(--muted);
    }

    .progress {
      height: 10px;
      background: #e9eef6;
      border-radius: 999px;
      overflow: hidden;
      margin: 8px auto 12px;
      width: 60%;
      max-width: 420px;
    }

    .progress-fill {
      height: 100%;
      border-radius: 999px;
      transition: width 0.6s ease;
    }

    .summary-box {
      background: #f7f9fc;
      border-left: 4px solid var(--primary);
      padding: 14px 18px;
      border-radius: 6px;
      margin: 18px auto;
      max-width: 720px;
      line-height: 1.6;
      font-size: 15px;
    }

    .muted {
      color: var(--muted);
      font-size: 0.95em;
      margin-top: 4px;
      font-style: italic;
    }

    canvas {
      display: block;
      margin: 24px auto 8px;
    }

    .cols {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 18px;
      margin-top: 24px;
    }

    .card {
      background: #fff;
      border: 1px solid #e0e7f0;
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.04);
    }

    .card h3 {
      margin-top: 0;
      color: var(--primary);
      font-size: 17px;
      margin-bottom: 8px;
    }

    .card b {
      font-size: 16px;
    }

    .bar {
      height: 10px;
      background: var(--bar);
      border-radius: 999px;
      overflow: hidden;
      margin: 6px 0 10px;
    }

    .fill {
      height: 100%;
      transition: width 0.6s ease;
    }

    .fill.ok {
      background: var(--ok);
    }

    .fill.warn {
      background: var(--warn);
    }

    .fill.bad {
      background: var(--bad);
    }

    blockquote {
      background: #f7f9fc;
      border-left: 4px solid var(--primary);
      margin: 8px 0;
      padding: 8px 12px;
      font-style: italic;
      color: #333;
    }
  </style>
</head>

<body>
  <header>
    <h1>üß† De Facto</h1>
    <p>Analyse de fiabilit√© et de rigueur m√©diatique</p>
  </header>

  <main>
    <textarea id="inputText" placeholder="Collez un article, un post, ou un extrait‚Ä¶"></textarea>
    <button id="analyzeBtn">Analyser</button>
    <div id="result" class="result"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const isLocal = window.location.hostname === "localhost" || window.location.hostname.includes("replit");
    const API = isLocal ? "/analyze" : "https://de-facto-backend.onrender.com/analyze";
    const $ = (s) => document.querySelector(s);
    const resultDiv = $("#result");

    $("#analyzeBtn").onclick = async () => {
      const text = $("#inputText").value.trim();
      if (!text) { alert("Merci d‚Äôentrer un texte."); return; }
      resultDiv.innerHTML = "<p style='text-align:center;'>‚è≥ Analyse en cours‚Ä¶</p>";

      try {
        const r = await fetch(API, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text })
        });
        const data = await r.json();
        if (!r.ok || data.error) throw new Error(data.error || ("HTTP " + r.status));
        render(data);
      } catch (e) {
        resultDiv.innerHTML = `<div style="background:#fde2e1;border:1px solid #f5b5b0;color:#842029;padding:10px;border-radius:8px;text-align:center;">‚ùå ${e.message}</div>`;
      }
    };

    function render(d) {
      resultDiv.innerHTML = "";

      const scoreColor = d.score_global >= 70 ? "var(--ok)" :
        d.score_global >= 40 ? "var(--warn)" : "var(--bad)";

      const scoreSection = `
        <div class="score">
          <h2>${safeNum(d.score_global)} / 100</h2>
          <div class="progress">
            <div class="progress-fill" style="width:${d.score_global || 0}%; background:${scoreColor};"></div>
          </div>
          <p><b>Confiance :</b> ${safeNum(d.confiance_analyse)}%</p>
          <p class="muted"><i>Analyse exp√©rimentale : De Facto est en am√©lioration continue.</i></p>
        </div>
      `;

      const summaryBox = `
        <div class="summary-box">${esc(d.resume || d.commentaire || "Synth√®se non disponible.")}</div>
      `;

      resultDiv.insertAdjacentHTML("beforeend", scoreSection + summaryBox);

      // --- Radar Chart √©pur√© et centr√© ---
      const canvas = document.createElement("canvas");
      canvas.style.maxWidth = "440px";
      canvas.style.height = "440px";
      canvas.style.display = "block";
      canvas.style.margin = "24px auto";
      resultDiv.appendChild(canvas);

      new Chart(canvas, {
        type: "radar",
        data: {
          labels: ["Justesse", "Compl√©tude", "Ton", "Sophismes"],
          datasets: [{
            label: "√âvaluation",
            data: [
              d.axes?.fond?.justesse?.note || 0,
              d.axes?.fond?.completude?.note || 0,
              d.axes?.forme?.ton?.note || 0,
              d.axes?.forme?.sophismes?.note || 0
            ],
            backgroundColor: "rgba(10, 74, 154, 0.08)",
            borderColor: "rgba(10, 74, 154, 0.8)",
            borderWidth: 2,
            pointBackgroundColor: "rgba(10, 74, 154, 1)",
            pointRadius: 3,
            pointHoverRadius: 5,
            tension: 0
          }]
        },
        options: {
          layout: { padding: 10 },
          scales: {
            r: {
              beginAtZero: true,
              max: 100,
              min: 0,
              ticks: { display: false },
              grid: { color: "rgba(0, 0, 0, 0.05)", lineWidth: 1.2 },
              angleLines: { color: "rgba(0, 0, 0, 0.08)", lineWidth: 1 },
              pointLabels: {
                font: { size: 13, weight: 500 },
                color: "#333"
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              backgroundColor: "#0a4a9a",
              titleFont: { size: 13 },
              bodyFont: { size: 13 },
              padding: 8,
              cornerRadius: 6
            }
          },
          elements: { line: { borderJoinStyle: "round" } }
        }
      });

      // --- Cartes FOND / FORME ---
      const fond = d.axes?.fond || {};
      const forme = d.axes?.forme || {};

      const cards = `
        <div class="cols">
          ${card("Justesse", fond.justesse)}
          ${card("Compl√©tude", fond.completude)}
          ${card("Ton", forme.ton)}
          ${card("Sophismes", forme.sophismes)}
        </div>
      `;
      resultDiv.insertAdjacentHTML("beforeend", cards);
    }

    function card(title, crit) {
      if (!crit) return "";
      const cls = emojiClass(crit.couleur);
      return `
        <div class="card">
          <h3>${esc(title)} ${crit.couleur || ""}</h3>
          <b>${safeNum(crit.note)}/100</b>
          <div class="bar"><div class="fill ${cls}" style="width:${crit.note || 0}%"></div></div>
          <p>${esc(crit.justification || "‚Äî")}</p>
          ${crit.citation ? `<blockquote>¬´ ${esc(crit.citation)} ¬ª</blockquote>` : ""}
        </div>
      `;
    }

    function emojiClass(e) {
      if (e === "üü¢") return "ok";
      if (e === "üü°") return "warn";
      if (e === "üî¥") return "bad";
      return "";
    }

    function safeNum(v) { return (typeof v === "number" && isFinite(v)) ? v : "‚Äì"; }
    function esc(str) { return (str || "").replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" }[m])); }
  </script>
</body>

</html>
