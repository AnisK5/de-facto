<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>De Facto ‚Äì Barom√®tre de Fiabilit√©</title>

  <!-- ‚úÖ Chart.js pour le radar -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* -------------------------------------
       üé® BASE DESIGN ‚Äî neutre et journalistique
    ------------------------------------- */
    :root {
      --bg: #f6f8fb;
      --card: #fff;
      --text: #222;
      --muted: #667;
      --primary: #0a4a9a;
      --ok: #14a44d;
      --warn: #f4a100;
      --bad: #d33c3c;
      --border: #dde2ea;
    }

    body {
      font-family: system-ui, "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
    }

    header {
      background: #0e1117;
      color: #fff;
      text-align: center;
      padding: 1.5rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.8rem;
    }

    main {
      max-width: 960px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    textarea {
      width: 100%;
      min-height: 160px;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      font-size: 15px;
      background: #fff;
      resize: vertical;
    }

    button {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 15px;
      margin-top: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #0c5ed0;
    }

    .result {
      margin-top: 22px;
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 6px 24px rgba(0, 0, 0, .06);
      padding: 24px;
    }

    /* -------------------------------------
       üß† SYNTH√àSE CONTEXTUELLE
    ------------------------------------- */
    .synthese {
      font-size: 1.1rem;
      background: #f3f6fc;
      border-left: 4px solid var(--primary);
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 18px;
    }

    /* -------------------------------------
       üìä RADAR CHART
    ------------------------------------- */
    .chart-container {
      width: 340px;
      margin: 0 auto 18px auto;
    }

    /* -------------------------------------
       üßæ SCORECARD
    ------------------------------------- */
    .score-top {
      text-align: center;
      margin-bottom: 10px;
    }

    .score-top .note {
      font-size: 2.4rem;
      font-weight: bold;
    }

    .muted {
      color: var(--muted);
    }

    .alert {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      margin-top: 10px;
    }

    .card h3 {
      margin-top: 0;
      font-size: 1.1rem;
    }

    .toggle {
      background: #eef3fb;
      color: var(--primary);
      border: 1px solid #cfe0ff;
      margin-top: 16px;
    }

    .details {
      display: none;
      margin-top: 14px;
    }

    blockquote {
      background: #f7f9fc;
      border-left: 4px solid var(--primary);
      margin: 8px 0;
      padding: 8px 12px;
      font-style: italic;
    }
  </style>
</head>

<body>
  <header>
    <h1>üß† De Facto</h1>
    <p>Barom√®tre de fiabilit√© et de rigueur argumentative</p>
  </header>

  <main>
    <textarea id="inputText" placeholder="Collez un article, un post, ou un extrait‚Ä¶"></textarea>
    <button id="analyzeBtn">Analyser</button>

    <div id="result" class="result"></div>
  </main>

  <script>
    /* -------------------------------------
       üîå API D√âTECTION : local / replit / render
    ------------------------------------- */
    const isLocal = window.location.hostname === "localhost" || window.location.hostname.includes("replit");
    const API = isLocal ? "/analyze" : "https://de-facto-backend.onrender.com/analyze";
    const $ = (s) => document.querySelector(s);
    const resultDiv = $("#result");

    $("#analyzeBtn").onclick = async () => {
      const text = $("#inputText").value.trim();
      if (!text) { alert("Merci d‚Äôentrer un texte."); return; }
      resultDiv.innerHTML = "‚è≥ Analyse en cours‚Ä¶";

      try {
        const r = await fetch(API, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text })
        });
        const data = await r.json();
        if (!r.ok || data.error) throw new Error(data.error || ("HTTP " + r.status));
        render(data);
      } catch (e) {
        resultDiv.innerHTML = `<div class="alert" style="background:#fde2e1;border-color:#f5b5b0;color:#842029">‚ùå ${e.message}</div>`;
      }
    };

    /* -------------------------------------
       üß† RENDU PRINCIPAL
    ------------------------------------- */
    function render(d) {
      resultDiv.innerHTML = "";

      // üî∏ Bandeau si texte tronqu√©
      if (d.texte_tronque) {
        resultDiv.insertAdjacentHTML("beforeend",
          `<div class="alert">‚ö†Ô∏è <b>Attention :</b> texte long ‚Äî seuls les premiers <b>8 000 caract√®res</b> ont √©t√© analys√©s.</div>`);
      }

      // üîπ Synth√®se contextuelle
      resultDiv.insertAdjacentHTML("beforeend", `
        <div class="score-top">
          <div class="note">${safeNum(d.score_global)} / 100</div>
          <p><b>Confiance :</b> ${safeNum(d.confiance_analyse)}%</p>
          <p class="muted">${d.limites_analyse_ia?.[0] || "Analyse exp√©rimentale ‚Äî peut contenir des impr√©cisions."}</p>
        </div>
        ${d.synthese_contextuelle ? `<div class="synthese">${esc(d.synthese_contextuelle)}</div>` : ""}
      `);

      // üîπ Radar Chart
      const fond = d.axes?.fond || {};
      const forme = d.axes?.forme || {};
      const chartEl = document.createElement("div");
      chartEl.className = "chart-container";
      chartEl.innerHTML = `<canvas id="radarChart"></canvas>`;
      resultDiv.appendChild(chartEl);
      drawRadar({
        justesse: fond.justesse?.note || 0,
        completude: fond.completude?.note || 0,
        ton: forme.ton?.note || 0,
        sophismes: forme.sophismes?.note || 0
      });

      // üîπ D√©tails analytiques
      resultDiv.insertAdjacentHTML("beforeend", `
        <button class="toggle" onclick="toggleDetails()">Voir les d√©tails ‚Üì</button>
        <div class="details" id="details">
          ${detailBlock("Justesse", fond.justesse)}
          ${detailBlock("Compl√©tude", fond.completude)}
          ${detailBlock("Ton", forme.ton)}
          ${detailBlock("Sophismes", forme.sophismes)}
          ${d.commentaire ? `<div class="card"><b>R√©sum√© final :</b> ${esc(d.commentaire)}</div>` : ""}
        </div>
      `);
    }

    /* -------------------------------------
       üìà RADAR DRAWER
    ------------------------------------- */
    function drawRadar(values) {
      const ctx = document.getElementById("radarChart");
      new Chart(ctx, {
        type: "radar",
        data: {
          labels: ["Justesse", "Compl√©tude", "Ton", "Sophismes"],
          datasets: [{
            label: "Fiabilit√©",
            data: Object.values(values),
            backgroundColor: "rgba(10, 74, 154, 0.2)",
            borderColor: "#0a4a9a",
            borderWidth: 2,
            pointBackgroundColor: "#0a4a9a"
          }]
        },
        options: {
          scales: {
            r: {
              min: 0,
              max: 100,
              ticks: { stepSize: 20, color: "#667" },
              grid: { color: "#ccd" },
              angleLines: { color: "#ccd" }
            }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    /* -------------------------------------
       üß© UI HELPERS
    ------------------------------------- */
    function toggleDetails() {
      const el = document.getElementById("details");
      const btn = document.querySelector(".toggle");
      const open = el.style.display === "block";
      el.style.display = open ? "none" : "block";
      btn.textContent = open ? "Voir les d√©tails ‚Üì" : "Masquer les d√©tails ‚Üë";
    }

    function detailBlock(label, crit) {
      if (!crit) return "";
      return `
        <div class="card">
          <h3>${esc(label)} ${crit.couleur || ""}</h3>
          <p>${esc(crit.justification || "‚Äî")}</p>
          ${crit.citation ? `<blockquote>¬´ ${esc(crit.citation)} ¬ª</blockquote>` : ""}
        </div>
      `;
    }

    function safeNum(v) { return (typeof v === "number" && isFinite(v)) ? v : "‚Äì"; }
    function esc(str) { return (str || "").replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" }[m])); }
  </script>
</body>
</html>
